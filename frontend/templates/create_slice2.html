<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleFlow - Crear Slice</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
        body { background: #f8fafc; min-height: 100vh; }
        
        /* Top Bar Styles */
        .top-bar { 
            background: #ffffff; 
            border-bottom: 1px solid #e2e8f0; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); 
            padding: 1rem 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        .logo-icon { 
            width: 40px; 
            height: 40px; 
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.25); 
        }
        .user-badge { 
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); 
            border: 1px solid #cbd5e1; 
            border-radius: 10px; 
            padding: 0.5rem 1rem; 
        }
        .user-avatar { 
            width: 32px; 
            height: 32px; 
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); 
            border-radius: 50%; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        /* Main Content */
        .main-content { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 2rem 1.5rem; 
            padding-top: 100px;
        }
        
        /* Progress Indicator */
        .progress-indicator {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .progress-step span {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #f1f5f9;
            color: #64748b;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.875rem;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .progress-step.active span {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            border-color: #0284c7;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }
        .progress-step.completed span {
            background: #dcfce7;
            color: #166534;
            border-color: #86efac;
        }
        
        /* Step Container */
        .slice-designer {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            padding: 2rem;
        }
        .step-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        .step-number {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }
        .step-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #0f172a;
            margin: 0;
        }
        
        /* Form Elements */
        .form-control, .form-select {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        .form-floating > label {
            color: #64748b;
            font-weight: 500;
        }
        
        /* VM Cards */
        .vm-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        .vm-card h5 {
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }
        .vm-card h5 i {
            color: #0ea5e9;
            margin-right: 0.5rem;
        }
        
        /* Buttons */
        .btn {
            font-weight: 500;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border: none;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .btn-gradient {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .btn-outline-secondary {
            color: #64748b;
            border: 2px solid #cbd5e1;
            background: #f8fafc;
        }
        .btn-outline-secondary:hover {
            background: #e2e8f0;
            border-color: #94a3b8;
            color: #475569;
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .btn-outline-light {
            color: #64748b;
            border: 2px solid #cbd5e1;
            background: #f8fafc;
        }
        .btn-outline-light:hover {
            background: #e2e8f0;
            border-color: #94a3b8;
            color: #475569;
        }
        .btn-sm {
            padding: 0.4rem 0.85rem;
            font-size: 0.8rem;
        }
        
        /* Topology Styles */
        .topology-container {
            display: flex;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        .topology-controls {
            flex: 0 0 280px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
        }
        .topology-controls h5, .topology-controls h6 {
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 1rem;
        }
        .topology-option {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        .topology-option:hover {
            border-color: #bae6fd;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .topology-option.active {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            border-color: #0284c7;
            color: white;
        }
        .topology-option i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }
        .topology-visualizer {
            flex: 1;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            min-height: 500px;
        }
        #network-container {
            width: 100%;
            height: 500px;
        }
        .topology-stats {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            color: #475569;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Navigation Controls */
        .direction-controls {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            display: grid;
            grid-template-columns: repeat(3, 40px);
            grid-template-rows: repeat(3, 40px);
            gap: 4px;
            z-index: 10;
        }
        .direction-btn {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #475569;
        }
        .direction-btn:hover {
            background: #0ea5e9;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }
        .direction-btn.up { grid-column: 2; grid-row: 1; }
        .direction-btn.left { grid-column: 1; grid-row: 2; }
        .direction-btn.center { grid-column: 2; grid-row: 2; }
        .direction-btn.right { grid-column: 3; grid-row: 2; }
        .direction-btn.down { grid-column: 2; grid-row: 3; }
        
        .navigation-controls {
            position: absolute;
            right: 1rem;
            top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10;
        }
        .nav-control-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #475569;
        }
        .nav-control-btn:hover {
            background: #0ea5e9;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }
        
        /* Preset Topologies */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .preset-btn {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        .preset-btn:hover {
            border-color: #0ea5e9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
        }
        .preset-btn i {
            font-size: 1.75rem;
            color: #0ea5e9;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        /* Review Table */
        .table {
            margin-bottom: 0;
        }
        .table thead {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        }
        .table thead th {
            padding: 1rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
        }
        .table tbody tr {
            transition: all 0.15s ease;
            border-bottom: 1px solid #f1f5f9;
        }
        .table tbody tr:hover {
            background: #f8fafc;
        }
        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
        }
        
        /* Badge */
        .badge {
            padding: 0.35rem 0.85rem;
            border-radius: 16px;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            border: 1px solid;
        }
        .bg-success {
            background-color: #dcfce7 !important;
            color: #166534 !important;
            border-color: #86efac !important;
        }
        .bg-info {
            background-color: #dbeafe !important;
            color: #1e40af !important;
            border-color: #93c5fd !important;
        }
        .bg-secondary {
            background-color: #f1f5f9 !important;
            color: #475569 !important;
            border-color: #cbd5e1 !important;
        }
        
        /* Modal */
        .modal-content {
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }
        .modal-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 2px solid #e2e8f0;
            border-radius: 12px 12px 0 0;
        }
        .modal-title {
            font-weight: 700;
            color: #0f172a;
        }
        .alert-info {
            background-color: #dbeafe;
            border-color: #93c5fd;
            color: #1e40af;
            border-radius: 8px;
        }
        
        /* Form Check Switch */
        .form-check-input:checked {
            background-color: #10b981;
            border-color: #10b981;
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <nav class="top-bar">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <div class="logo-icon"><i class="fas fa-network-wired text-white"></i></div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #0f172a;">TeleFlow</div>
                        <small style="font-size: 0.7rem; color: #64748b; font-weight: 500;">Diseñador de Slice</small>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <a href="/dashboard" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                    </a>
                    <a href="/logout" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-sign-out-alt me-1"></i>Salir
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Progress Indicator -->
        <div class="progress-indicator">
            <div class="progress-step active">
                <span>Información Básica</span>
            </div>
            <div class="progress-step">
                <span>Configuración VMs</span>
            </div>
            <div class="progress-step">
                <span>Diseño de Red</span>
            </div>
            <div class="progress-step">
                <span>Revisión</span>
            </div>
        </div>

        <form method="POST" id="create-slice-form">
            <!-- Step 1: Información Básica -->
            <div class="slice-designer" id="step-1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <h3 class="step-title">Información del Slice</h3>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="slice-name" name="slice_name" placeholder="Nombre del slice" required>
                            <label for="slice-name">Nombre del Slice</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="vm-count" name="num_vms" placeholder="Número de VMs" min="2" max="20" value="3" required>
                            <label for="vm-count">Número de VMs</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-floating mb-3">
                    <textarea class="form-control" id="slice-description" name="slice_description" placeholder="Descripción" style="height: 100px"></textarea>
                    <label for="slice-description">Descripción (opcional)</label>
                </div>
                
                <div class="text-end">
                    <button type="button" class="btn btn-gradient btn-lg" onclick="nextStep()">
                        Configurar VMs <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Configuración de VMs -->
            <div class="slice-designer" id="step-2" style="display: none;">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <h3 class="step-title">Configuración de Máquinas Virtuales</h3>
                </div>
                
                <div id="vm-configurations">
                    <!-- VM cards will be generated here -->
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary btn-lg" onclick="previousStep()">
                        <i class="fas fa-arrow-left me-2"></i>Anterior
                    </button>
                    <button type="button" class="btn btn-gradient btn-lg" onclick="nextStep()">
                        Diseñar Red <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Diseño de Red -->
            <div class="slice-designer" id="step-3" style="display: none;">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <h3 class="step-title">Diseño de Topología de Red</h3>
                </div>
                
                <div class="topology-container">
                    <div class="topology-controls">
                        <h5><i class="fas fa-tools me-2"></i>Herramientas</h5>
                        
                        <div class="mb-4">
                            <h6>Tipo de Topología</h6>
                            <div class="topology-option active" data-type="custom" onclick="selectTopologyType('custom')">
                                <i class="fas fa-paint-brush"></i>
                                <div><strong>Personalizada</strong></div>
                                <small>Diseño libre</small>
                            </div>
                            <div class="topology-option" data-type="template" onclick="selectTopologyType('template')">
                                <i class="fas fa-shapes"></i>
                                <div><strong>Plantilla</strong></div>
                                <small>Predefinidas</small>
                            </div>
                        </div>

                        <div id="custom-controls">
                            <h6>Controles</h6>
                            <button type="button" class="btn btn-success btn-sm w-100 mb-2" onclick="addNode()">
                                <i class="fas fa-plus me-1"></i>Agregar Nodo
                            </button>
                            <button type="button" class="btn btn-primary btn-sm w-100 mb-2" onclick="toggleConnectionMode()">
                                <i class="fas fa-link me-1"></i>Modo Conexión
                            </button>
                            <button type="button" class="btn btn-warning btn-sm w-100 mb-2" onclick="clearTopology()">
                                <i class="fas fa-trash me-1"></i>Limpiar
                            </button>
                            
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Click en nodos para conectar
                                </small>
                            </div>
                        </div>

                        <div id="template-controls" style="display: none;">
                            <h6>Plantillas</h6>
                            <p class="text-muted small"><i class="fas fa-info-circle me-1"></i>Click para agregar</p>
                            <div class="preset-grid">
                                <div class="preset-btn" onclick="showTopologyModal('star')">
                                    <i class="fas fa-star"></i>
                                    <small>Estrella</small>
                                </div>
                                <div class="preset-btn" onclick="showTopologyModal('tree')">
                                    <i class="fas fa-sitemap"></i>
                                    <small>Árbol</small>
                                </div>
                                <div class="preset-btn" onclick="showTopologyModal('ring')">
                                    <i class="fas fa-circle-notch"></i>
                                    <small>Anillo</small>
                                </div>
                                <div class="preset-btn" onclick="showTopologyModal('mesh')">
                                    <i class="fas fa-project-diagram"></i>
                                    <small>Malla</small>
                                </div>
                                <div class="preset-btn" onclick="showTopologyModal('linear')">
                                    <i class="fas fa-grip-lines"></i>
                                    <small>Lineal</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="topology-visualizer">
                        <div id="network-container"></div>
                        
                        <div class="direction-controls">
                            <div class="direction-btn up" onclick="moveView('up')" title="Arriba">
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="direction-btn left" onclick="moveView('left')" title="Izquierda">
                                <i class="fas fa-chevron-left"></i>
                            </div>
                            <div class="direction-btn center" onclick="centerView()" title="Centrar">
                                <i class="fas fa-crosshairs"></i>
                            </div>
                            <div class="direction-btn right" onclick="moveView('right')" title="Derecha">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <div class="direction-btn down" onclick="moveView('down')" title="Abajo">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        
                        <div class="navigation-controls">
                            <div class="nav-control-btn" onclick="fitToScreen()" title="Ajustar">
                                <i class="fas fa-expand-arrows-alt"></i>
                            </div>
                            <div class="nav-control-btn" onclick="zoomOut()" title="Zoom Out">
                                <i class="fas fa-minus"></i>
                            </div>
                            <div class="nav-control-btn" onclick="zoomIn()" title="Zoom In">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                        
                        <div class="topology-stats">
                            <span id="node-count">Nodos: 0</span> | 
                            <span id="edge-count">Conexiones: 0</span>
                        </div>
                    </div>
                </div>

                <input type="hidden" id="topology_data" name="topology_data">
                <input type="hidden" id="topology_type" name="topology_type" value="custom">
                
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary btn-lg" onclick="previousStep()">
                        <i class="fas fa-arrow-left me-2"></i>Anterior
                    </button>
                    <button type="button" class="btn btn-gradient btn-lg" onclick="nextStep()">
                        Revisar <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 4: Revisión -->
            <div class="slice-designer" id="step-4" style="display: none;">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <h3 class="step-title">Revisión y Creación</h3>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="vm-card">
                            <h5><i class="fas fa-info-circle me-2"></i>Información del Slice</h5>
                            <p><strong>Nombre:</strong> <span id="review-name"></span></p>
                            <p><strong>VMs:</strong> <span id="review-vm-count"></span></p>
                            <p><strong>Descripción:</strong> <span id="review-description"></span></p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="vm-card">
                            <h5><i class="fas fa-project-diagram me-2"></i>Topología</h5>
                            <p><strong>Nodos:</strong> <span id="review-nodes"></span></p>
                            <p><strong>Conexiones:</strong> <span id="review-connections"></span></p>
                            <p><strong>Tipo:</strong> <span id="review-topology-type"></span></p>
                        </div>
                    </div>
                </div>
                
                <div class="vm-card">
                    <h5><i class="fas fa-server me-2"></i>Configuración de VMs</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Imagen</th>
                                    <th>CPU</th>
                                    <th>RAM</th>
                                    <th>Storage</th>
                                    <th>Internet</th>
                                </tr>
                            </thead>
                            <tbody id="vm-review-list">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary btn-lg" onclick="previousStep()">
                        <i class="fas fa-arrow-left me-2"></i>Anterior
                    </button>
                    <button type="submit" class="btn btn-gradient btn-lg">
                        <i class="fas fa-rocket me-2"></i>Crear Slice
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="topologyModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-network-wired me-2"></i>Agregar Topología <span id="topology-name-modal"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        La topología se agregará a los nodos existentes.
                    </div>
                    <div class="form-group">
                        <label for="topology-vm-count" class="form-label">
                            <strong>¿Cuántas VMs para esta topología?</strong>
                        </label>
                        <input type="number" class="form-control form-control-lg" id="topology-vm-count" min="2" value="3">
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-server me-1"></i>
                            VMs disponibles: <span id="available-vms"></span>
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="confirmAddTopology()">
                        <i class="fas fa-plus me-1"></i>Agregar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStep = 1;
        let network = null;
        let nodes = new vis.DataSet();
        let edges = new vis.DataSet();
        let nodeId = 1;
        let connectionMode = false;
        let selectedNode = null;
        let topologyType = 'custom';
        let currentScale = 1;
        let viewPosition = { x: 0, y: 0 };
        let selectedTopologyTemplate = null;
        let topologyModal = null;

        document.addEventListener('DOMContentLoaded', function() {
            initializeNetworkVisualization();
            generateVMConfiguration();
            topologyModal = new bootstrap.Modal(document.getElementById('topologyModal'));
        });

        function moveView(direction) {
            if (network) {
                const currentPosition = network.getViewPosition();
                const moveDistance = 100;
                let newPosition = { ...currentPosition };

                switch(direction) {
                    case 'up': newPosition.y -= moveDistance; break;
                    case 'down': newPosition.y += moveDistance; break;
                    case 'left': newPosition.x -= moveDistance; break;
                    case 'right': newPosition.x += moveDistance; break;
                }

                network.moveTo({
                    position: newPosition,
                    animation: { duration: 300, easingFunction: 'easeInOutQuad' }
                });
            }
        }

        function centerView() {
            if (network && nodes.length > 0) {
                network.fit({
                    animation: { duration: 800, easingFunction: 'easeInOutQuad' }
                });
            } else if (network) {
                network.moveTo({
                    position: { x: 0, y: 0 },
                    scale: 1,
                    animation: { duration: 500, easingFunction: 'easeInOutQuad' }
                });
            }
            updateZoomDisplay();
        }

        function fitToScreen() {
            if (network) {
                if (nodes.length > 0) {
                    network.fit({
                        animation: { duration: 800, easingFunction: 'easeInOutQuad' }
                    });
                } else {
                    network.moveTo({
                        position: { x: 0, y: 0 },
                        scale: 1,
                        animation: { duration: 500, easingFunction: 'easeInOutQuad' }
                    });
                }
                updateZoomDisplay();
            }
        }

        function zoomIn() {
            if (network) {
                currentScale = Math.min(currentScale * 1.2, 3);
                const position = network.getViewPosition();
                network.moveTo({
                    position: position,
                    scale: currentScale,
                    animation: { duration: 300, easingFunction: 'easeInOutQuad' }
                });
                updateZoomDisplay();
            }
        }

        function zoomOut() {
            if (network) {
                currentScale = Math.max(currentScale / 1.2, 0.2);
                const position = network.getViewPosition();
                network.moveTo({
                    position: position,
                    scale: currentScale,
                    animation: { duration: 300, easingFunction: 'easeInOutQuad' }
                });
                updateZoomDisplay();
            }
        }

        function updateZoomDisplay() {
            currentScale = network ? network.getScale() : 1;
        }

        function initializeNetworkVisualization() {
            const container = document.getElementById('network-container');
            const data = { nodes: nodes, edges: edges };
            const options = {
                nodes: {
                    shape: 'circle',
                    size: 30,
                    font: { size: 14, color: '#333' },
                    borderWidth: 3,
                    color: {
                        background: '#28a745',
                        border: '#1e7e34',
                        highlight: { background: '#20c997', border: '#17a2b8' }
                    }
                },
                edges: {
                    width: 3,
                    color: '#6c757d',
                    smooth: { type: 'continuous' }
                },
                physics: {
                    enabled: true,
                    stabilization: { iterations: 100 }
                },
                interaction: {
                    dragNodes: true,
                    dragView: true,
                    zoomView: true
                }
            };

            network = new vis.Network(container, data, options);
            
            network.on('zoom', function(params) {
                currentScale = params.scale;
            });
            
            network.on('dragEnd', function(params) {
                viewPosition = network.getViewPosition();
            });
            
            network.on('click', function(params) {
                if (connectionMode && params.nodes.length > 0) {
                    handleNodeClick(params.nodes[0]);
                }
            });

            updateStats();
        }

        function nextStep() {
            if (!validateStep(currentStep)) return;
            
            document.getElementById(`step-${currentStep}`).style.display = 'none';
            updateProgress(currentStep, 'completed');
            currentStep++;
            updateProgress(currentStep, 'active');
            document.getElementById(`step-${currentStep}`).style.display = 'block';
            
            if (currentStep === 2) {
                generateVMConfiguration();
            } else if (currentStep === 4) {
                generateReview();
            }
        }

        function previousStep() {
            document.getElementById(`step-${currentStep}`).style.display = 'none';
            updateProgress(currentStep, '');
            currentStep--;
            updateProgress(currentStep, 'active');
            document.getElementById(`step-${currentStep}`).style.display = 'block';
        }

        function updateProgress(step, status) {
            const progressStep = document.querySelectorAll('.progress-step')[step - 1];
            progressStep.className = `progress-step ${status}`;
        }

        function validateStep(step) {
            switch(step) {
                case 1:
                    const sliceName = document.getElementById('slice-name').value;
                    const vmCount = document.getElementById('vm-count').value;
                    if (!sliceName.trim()) {
                        alert('Por favor ingresa un nombre para el slice');
                        return false;
                    }
                    if (!vmCount || vmCount < 2) {
                        alert('El número mínimo de VMs es 2');
                        return false;
                    }
                    return true;
                case 2:
                    const vmCount2 = parseInt(document.getElementById('vm-count').value);
                    for (let i = 1; i <= vmCount2; i++) {
                        const vmName = document.getElementById(`vm-${i}-name`).value.trim();
                        const vmImage = document.getElementById(`vm_${i}_image`).value;
                        const vmCpu = document.getElementById(`vm-${i}-cpu`).value;
                        const vmRam = document.getElementById(`vm-${i}-ram`).value;
                        const vmStorage = document.getElementById(`vm-${i}-storage`).value;
                        
                        if (!vmName || !vmImage || !vmCpu || !vmRam || !vmStorage) {
                            alert(`Por favor completa toda la configuración de la VM ${i}`);
                            return false;
                        }
                    }
                    return true;
                case 3:
                    if (nodes.length < 2) {
                        alert('La topología debe tener al menos 2 nodos');
                        return false;
                    }
                    updateTopologyData();
                    return true;
                default:
                    return true;
            }
        }

        function generateVMConfiguration() {
            const vmCount = parseInt(document.getElementById('vm-count').value);
            const container = document.getElementById('vm-configurations');
            container.innerHTML = '';

            for (let i = 1; i <= vmCount; i++) {
                const vmCard = document.createElement('div');
                vmCard.className = 'vm-card';
                vmCard.innerHTML = `
                    <h5><i class="fas fa-desktop me-2"></i>VM ${i}</h5>
                    <div class="row">
                        <div class="col-md-2 mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="vm-${i}-name" name="vm_${i}_name" value="VM${i}" required>
                                <label for="vm-${i}-name">Nombre</label>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="form-floating">
                                <select class="form-select" id="vm-${i}-cpu" name="vm_${i}_cpu" required>
                                    <option value="1">1 Core</option>
                                    <option value="2">2 Cores</option>
                                    <option value="4">4 Cores</option>
                                </select>
                                <label for="vm-${i}-cpu">CPU</label>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="form-floating">
                                <select class="form-select" id="vm-${i}-ram" name="vm_${i}_ram" required>
                                    <option value="1GB">1GB</option>
                                    <option value="2GB">2GB</option>
                                    <option value="3GB">4GB</option>
                                    <option value="4GB">8GB</option>
                                </select>
                                <label for="vm-${i}-ram">RAM</label>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="form-floating">
                                <select class="form-select" id="vm-${i}-storage" name="vm_${i}_storage" required>
                                    <option value="10GB">10GB</option>
                                    <option value="15GB">15GB</option>
                                    <option value="20GB">20GB</option>
                                    <option value="25GB">25GB</option>
                                </select>
                                <label for="vm-${i}-storage">Storage</label>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="form-floating">
                                <select class="form-select" id="vm_${i}_image" name="vm_${i}_image" required>
                                    <option value="ubuntu:latest">Ubuntu</option>
                                    <option value="cirros:latest">CirrOS</option>
                                </select>
                                <label for="vm_${i}_image">Imagen</label>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3 d-flex align-items-center">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="vm_${i}_internet" name="vm_${i}_internet">
                                <label class="form-check-label" for="vm_${i}_internet">
                                    <i class="fas fa-globe me-1"></i>Internet
                                </label>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(vmCard);
            }
        }

        function selectTopologyType(type) {
            topologyType = type;
            document.querySelectorAll('[data-type]').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            if (type === 'custom') {
                document.getElementById('custom-controls').style.display = 'block';
                document.getElementById('template-controls').style.display = 'none';
            } else {
                document.getElementById('custom-controls').style.display = 'none';
                document.getElementById('template-controls').style.display = 'block';
            }
        }

        function addNode() {
            const vmCount = parseInt(document.getElementById('vm-count').value);
            if (nodes.length >= vmCount) {
                alert(`No se pueden agregar más nodos. Límite: ${vmCount} VMs`);
                return;
            }

            const newNode = {
                id: nodeId,
                label: `VM${nodeId}`,
                x: Math.random() * 400 - 200,
                y: Math.random() * 300 - 150
            };
            nodes.add(newNode);
            nodeId++;
            updateStats();
        }

        function toggleConnectionMode() {
            connectionMode = !connectionMode;
            const btn = document.querySelector('button[onclick="toggleConnectionMode()"]');
            if (connectionMode) {
                btn.innerHTML = '<i class="fas fa-times me-1"></i>Cancelar';
                btn.className = 'btn btn-danger btn-sm w-100 mb-2';
            } else {
                btn.innerHTML = '<i class="fas fa-link me-1"></i>Modo Conexión';
                btn.className = 'btn btn-primary btn-sm w-100 mb-2';
                selectedNode = null;
            }
        }

        function handleNodeClick(nodeId) {
            if (!selectedNode) {
                selectedNode = nodeId;
                nodes.update({id: nodeId, color: {background: '#ffc107', border: '#e0a800'}});
            } else {
                if (selectedNode !== nodeId) {
                    const existingEdge = edges.get().find(edge => 
                        (edge.from === selectedNode && edge.to === nodeId) ||
                        (edge.from === nodeId && edge.to === selectedNode)
                    );
                    
                    if (!existingEdge) {
                        edges.add({ from: selectedNode, to: nodeId });
                    } else {
                        alert('La conexión ya existe');
                    }
                }
                
                nodes.get().forEach(node => {
                    nodes.update({
                        id: node.id, 
                        color: {background: '#28a745', border: '#1e7e34'}
                    });
                });
                selectedNode = null;
                updateStats();
            }
        }

        function clearTopology() {
            if (confirm('¿Limpiar toda la topología?')) {
                nodes.clear();
                edges.clear();
                nodeId = 1;
                selectedNode = null;
                updateStats();
            }
        }

        function showTopologyModal(template) {
            selectedTopologyTemplate = template;
            
            const templateNames = {
                'star': 'Estrella',
                'tree': 'Árbol',
                'ring': 'Anillo',
                'mesh': 'Malla',
                'linear': 'Lineal'
            };
            document.getElementById('topology-name-modal').textContent = templateNames[template];
            
            const totalVMs = parseInt(document.getElementById('vm-count').value);
            const usedVMs = nodes.length;
            const availableVMs = totalVMs - usedVMs;
            
            document.getElementById('available-vms').textContent = availableVMs;
            
            const input = document.getElementById('topology-vm-count');
            input.max = availableVMs;
            input.value = Math.min(3, availableVMs);
            
            if (availableVMs < 2) {
                alert('No hay suficientes VMs disponibles');
                return;
            }
            
            topologyModal.show();
        }

        function confirmAddTopology() {
            const requestedVMs = parseInt(document.getElementById('topology-vm-count').value);
            const totalVMs = parseInt(document.getElementById('vm-count').value);
            const usedVMs = nodes.length;
            const availableVMs = totalVMs - usedVMs;
            
            if (requestedVMs < 2) {
                alert('Se requieren al menos 2 VMs');
                return;
            }
            
            if (requestedVMs > availableVMs) {
                alert(`Solo tienes ${availableVMs} VMs disponibles`);
                return;
            }
            
            topologyModal.hide();
            applyTemplateWithCount(selectedTopologyTemplate, requestedVMs);
        }

        function applyTemplateWithCount(template, vmCount) {
            let offsetX = 0;
            let offsetY = 0;
            
            if (nodes.length > 0) {
                const existingNodes = nodes.get();
                const maxX = Math.max(...existingNodes.map(n => n.x || 0));
                const maxY = Math.max(...existingNodes.map(n => n.y || 0));
                offsetX = maxX + 300;
                offsetY = maxY;
            }
            
            switch(template) {
                case 'star': generateStarTopologyAdditive(vmCount, offsetX, offsetY); break;
                case 'tree': generateTreeTopologyAdditive(vmCount, offsetX, offsetY); break;
                case 'ring': generateRingTopologyAdditive(vmCount, offsetX, offsetY); break;
                case 'mesh': generateMeshTopologyAdditive(vmCount, offsetX, offsetY); break;
                case 'linear': generateLinearTopologyAdditive(vmCount, offsetX, offsetY); break;
            }
            
            updateStats();
            setTimeout(() => { fitToScreen(); }, 500);
        }

        function generateStarTopologyAdditive(vmCount, offsetX, offsetY) {
            const startId = nodeId;
            const centerNode = { id: nodeId++, label: `VM${startId}`, x: offsetX, y: offsetY };
            nodes.add(centerNode);
            
            const radius = 150;
            for (let i = 1; i < vmCount; i++) {
                const angle = (2 * Math.PI * (i - 1)) / (vmCount - 1);
                const x = offsetX + radius * Math.cos(angle);
                const y = offsetY + radius * Math.sin(angle);
                
                const currentId = nodeId++;
                nodes.add({ id: currentId, label: `VM${currentId}`, x: x, y: y });
                edges.add({ from: startId, to: currentId });
            }
        }

        function generateTreeTopologyAdditive(vmCount, offsetX, offsetY) {
            const startId = nodeId;
            const levels = Math.ceil(Math.log2(vmCount + 1));
            let currentId = startId;
            
            nodes.add({ id: nodeId++, label: `VM${startId}`, x: offsetX, y: offsetY - 100 });
            
            for (let level = 1; level < levels && currentId < startId + vmCount - 1; level++) {
                const nodesInLevel = Math.pow(2, level);
                const yPos = offsetY + level * 80 - 100;
                const spacing = 300 / (nodesInLevel + 1);
                
                for (let i = 0; i < nodesInLevel && currentId < startId + vmCount - 1; i++) {
                    currentId++;
                    const xPos = offsetX + (i + 1) * spacing - 150;
                    
                    const newId = nodeId++;
                    nodes.add({ id: newId, label: `VM${newId}`, x: xPos, y: yPos });
                    
                    const parentId = startId + Math.floor((currentId - startId) / 2);
                    edges.add({ from: parentId, to: newId });
                }
            }
        }

        function generateRingTopologyAdditive(vmCount, offsetX, offsetY) {
            const startId = nodeId;
            const radius = 120;
            
            for (let i = 0; i < vmCount; i++) {
                const angle = (2 * Math.PI * i) / vmCount;
                const x = offsetX + radius * Math.cos(angle);
                const y = offsetY + radius * Math.sin(angle);
                
                const currentId = nodeId++;
                nodes.add({ id: currentId, label: `VM${currentId}`, x: x, y: y });
                
                if (i > 0) {
                    edges.add({ from: currentId - 1, to: currentId });
                }
            }
            edges.add({ from: nodeId - 1, to: startId });
        }

        function generateMeshTopologyAdditive(vmCount, offsetX, offsetY) {
            const startId = nodeId;
            const radius = 100;
            const nodeIds = [];
            
            for (let i = 0; i < vmCount; i++) {
                const angle = (2 * Math.PI * i) / vmCount;
                const x = offsetX + radius * Math.cos(angle);
                const y = offsetY + radius * Math.sin(angle);
                
                const currentId = nodeId++;
                nodes.add({ id: currentId, label: `VM${currentId}`, x: x, y: y });
                nodeIds.push(currentId);
            }
            
            for (let i = 0; i < nodeIds.length; i++) {
                for (let j = i + 1; j < nodeIds.length; j++) {
                    edges.add({ from: nodeIds[i], to: nodeIds[j] });
                }
            }
        }

        function generateLinearTopologyAdditive(vmCount, offsetX, offsetY) {
            const spacing = 200 / (vmCount - 1);
            
            for (let i = 0; i < vmCount; i++) {
                const x = offsetX + i * spacing - 100;
                const currentId = nodeId++;
                nodes.add({ id: currentId, label: `VM${currentId}`, x: x, y: offsetY });
                
                if (i > 0) {
                    edges.add({ from: currentId - 1, to: currentId });
                }
            }
        }

        function updateStats() {
            document.getElementById('node-count').textContent = `Nodos: ${nodes.length}`;
            document.getElementById('edge-count').textContent = `Conexiones: ${edges.length}`;
        }

        function updateTopologyData() {
            const topologyData = {
                nodes: nodes.get(),
                edges: edges.get()
            };
            document.getElementById('topology_data').value = JSON.stringify(topologyData);
        }

        function generateReview() {
            document.getElementById('review-name').textContent = document.getElementById('slice-name').value;
            document.getElementById('review-vm-count').textContent = document.getElementById('vm-count').value;
            document.getElementById('review-description').textContent = document.getElementById('slice-description').value || 'Sin descripción';
            document.getElementById('review-nodes').textContent = nodes.length;
            document.getElementById('review-connections').textContent = edges.length;
            document.getElementById('review-topology-type').textContent = topologyType === 'custom' ? 'Personalizada' : 'Plantilla';
            
            const vmReviewList = document.getElementById('vm-review-list');
            vmReviewList.innerHTML = '';
            
            const vmCount = parseInt(document.getElementById('vm-count').value);
            for (let i = 1; i <= vmCount; i++) {
                const vmName = document.getElementById(`vm-${i}-name`).value;
                const vmImage = document.getElementById(`vm_${i}_image`).value;
                const vmCpu = document.getElementById(`vm-${i}-cpu`).value;
                const vmRam = document.getElementById(`vm-${i}-ram`).value;
                const vmStorage = document.getElementById(`vm-${i}-storage`).value;
                const vmInternet = document.getElementById(`vm_${i}_internet`).checked ? 'Sí' : 'No';
                
                const vmReview = document.createElement('tr');
                vmReview.innerHTML = `
                    <td><strong>${vmName}</strong></td>
                    <td><span class="badge bg-info">${vmImage}</span></td>
                    <td>${vmCpu} Core(s)</td>
                    <td>${vmRam}</td>
                    <td>${vmStorage}</td>
                    <td><span class="badge ${vmInternet === 'Sí' ? 'bg-success' : 'bg-secondary'}">${vmInternet}</span></td>
                `;
                vmReviewList.appendChild(vmReview);
            }
        }
    </script>
</body>
</html>