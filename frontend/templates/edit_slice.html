<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleFlow - Editar Slice</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        #custom-topology-container {
            height: 400px;
            border: 1px solid #ddd;
            margin: 20px 0;
            border-radius: 8px;
        }
        .vm-config-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .vm-config-card.existing {
            background-color: #f8f9fa;
            border-color: #6c757d;
        }
        .vm-config-card.new {
            background-color: #e8f5e8;
            border-color: #28a745;
        }
        .topology-selection {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        .topology-option {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .topology-option:hover {
            border-color: #28a745;
        }
        .topology-option.selected {
            border-color: #28a745;
            background-color: #f8f9fa;
        }
        .node-counter {
            background-color: #e9ecef;
            border-radius: 5px;
            padding: 8px 12px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .warning-box {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        .info-box {
            background-color: #e2f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            border-radius: 10px;
            text-align: center;
        }
        .ml-2 {
            margin-left: 0.5rem;
        }
        .vm-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .vm-indicator.existing {
            background-color: #6c757d;
            color: white;
        }
        .vm-indicator.new {
            background-color: #28a745;
            color: white;
        }
    </style>
</head>
<body class="dashboard-body">
    <div class="container-fluid p-0">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <div class="navbar-brand">
                    <i class="fas fa-cloud me-2"></i>
                    <strong>TeleFlow</strong>
                    <span class="ms-2 text-muted">| Editar Slice</span>
                </div>
                <div class="navbar-nav ms-auto">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle user-menu" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>{{ session.username }}
                        </a>
                        <div class="dropdown-menu dropdown-menu-end">
                            <a class="dropdown-item" href="{{ url_for('dashboard') }}">
                                <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="{{ url_for('logout') }}">
                                <i class="fas fa-sign-out-alt me-1"></i>Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <div class="page-header">
                <h1 class="page-title">Editar Slice: {{ slice.nombre or 'Slice #' + slice.idslice|string }}</h1>
                <p class="page-subtitle">Agrega nuevas VMs y modifica las conexiones de red existentes</p>
            </div>

            <div class="info-box">
                <h5><i class="fas fa-info-circle me-2"></i>Modo de Edición Seguro</h5>
                <p><strong>Solo puedes agregar nuevas VMs y modificar conexiones.</strong> Las VMs existentes se mantendrán intactas. Los cambios se guardarán en la base de datos.</p>
            </div>

            <form method="POST" id="edit-slice-form">
                <!-- Step 0: Slice Name -->
                <div class="content-card mb-4">
                    <h4><i class="fas fa-tag me-2"></i>Información del Slice</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="slice_name" class="form-label">Nombre del Slice</label>
                            <input type="text" class="form-control" id="slice_name" name="slice_name" value="{{ slice.nombre or '' }}" required placeholder="Ej: TEL141_2025-2_20206466">
                        </div>
                    </div>
                </div>
                
                <!-- Step 1: Number of VMs -->
                <div class="content-card mb-4">
                    <h4><i class="fas fa-server me-2"></i>Configuración de Instancias</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="num_new_vms" class="form-label">Número de nuevas VMs a agregar</label>
                            <input type="number" class="form-control" id="num_new_vms" name="num_new_vms" min="0" max="10" value="0" onchange="handleNewVMCountChange()">
                            <small class="text-muted">Actualmente tienes {{ slice.instancias|length }} VMs existentes</small>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Existing VMs (Read-only) -->
                <div class="content-card mb-4">
                    <h4><i class="fas fa-eye me-2"></i>VMs Existentes (Solo lectura)</h4>
                    <div id="existing-vm-configs">
                        <!-- Existing VM configurations will be generated here -->
                    </div>
                </div>

                <!-- Step 3: New VM Configuration -->
                <div class="content-card mb-4" id="new-vm-config-section" style="display: none;">
                    <h4><i class="fas fa-plus me-2"></i>Configuración de Nuevas VMs</h4>
                    <div id="new-vm-configs">
                        <!-- New VM configurations will be generated here -->
                    </div>
                </div>

                <!-- Step 4: Topology Selection -->
                <div class="content-card mb-4">
                    <h4><i class="fas fa-project-diagram me-2"></i>Modificar Topología</h4>
                    <div class="topology-selection">
                        <div class="topology-option selected" data-topology="custom" onclick="selectTopology('custom')">
                            <i class="fas fa-paint-brush fa-2x mb-2"></i>
                            <h6>Editar Conexiones</h6>
                            <small>Modifica las conexiones existentes y agrega nuevas</small>
                        </div>
                    </div>
                    <input type="hidden" id="topology_type" name="topology_type" value="custom" required>
                </div>

                <!-- Step 5: Custom Topology Designer -->
                <div class="content-card mb-4" id="custom-topology-card">
                    <h4><i class="fas fa-pencil-ruler me-2"></i>Editor de Topología</h4>
                    <p class="text-muted">Agrega conexiones entre VMs existentes y nuevas. Los cambios se guardarán automáticamente.</p>
                    
                    <div class="node-counter">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="node-count-display">VMs totales: {{ slice.instancias|length }}</span>
                        <span class="text-muted ms-2" id="total-vm-info">({{ slice.instancias|length }} existentes + 0 nuevas)</span>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <select id="fromNode" class="form-select form-select-sm">
                                <option value="">Nodo origen</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select id="toNode" class="form-select form-select-sm">
                                <option value="">Nodo destino</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-primary btn-sm" onclick="addCustomEdge()">
                                <i class="fas fa-link me-1"></i>Agregar Conexión
                            </button>
                        </div>
                    </div>
                    
                    <div id="custom-topology-container"></div>
                    <input type="hidden" id="topology_data" name="topology_data">
                </div>

                <!-- Submit Button -->
                <div class="content-card">
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Cancelar
                        </a>
                        <button type="button" class="btn btn-success" onclick="showConfirmModal()">
                            <i class="fas fa-save me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmación -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-save me-2"></i>Confirmar Cambios</h3>
            <p>Se guardarán las nuevas VMs y modificaciones de topología.</p>
            <p>Las VMs existentes no serán afectadas.</p>
            <p>¿Está seguro de que desea continuar?</p>
            <br>
            <button class="btn btn-success" onclick="confirmSave()">Sí, guardar cambios</button>
            <button class="btn btn-secondary ml-2" onclick="closeModal()">Cancelar</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let customNetwork = null;
        let customNodes = null;
        let customEdges = null;
        let existingVMCount = {{ slice.instancias|length }};
        let newVMCount = 0;
        
        // Convertir la topología actual de forma segura
        let currentTopology = {{ current_topology | tojson | safe }};
        if (!currentTopology || typeof currentTopology !== 'object') {
            currentTopology = { nodes: [], edges: [] };
        }

        // Datos de las instancias actuales (serializados correctamente)
        let existingInstances = {{ instances_data | tojson | safe }};

        function generateExistingVMConfig() {
            const container = document.getElementById('existing-vm-configs');
            container.innerHTML = '';

            existingInstances.forEach((instance, index) => {
                const vmCard = document.createElement('div');
                vmCard.className = 'vm-config-card existing';
                vmCard.innerHTML = `
                    <h6>
                        <i class="fas fa-desktop me-2"></i>
                        ${instance.nombre}
                        <span class="vm-indicator existing">EXISTENTE</span>
                    </h6>
                    <div class="row">
                        <div class="col-md-2">
                            <label class="form-label">CPU</label>
                            <input type="text" class="form-control" value="${instance.cpu}" readonly>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">RAM</label>
                            <input type="text" class="form-control" value="${instance.ram}" readonly>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Almacenamiento</label>
                            <input type="text" class="form-control" value="${instance.storage}" readonly>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Imagen</label>
                            <input type="text" class="form-control" value="${instance.imagen}" readonly>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Estado</label>
                            <input type="text" class="form-control" value="${instance.estado}" readonly>
                        </div>
                    </div>
                `;
                container.appendChild(vmCard);
            });
        }

        function generateNewVMConfig() {
            const container = document.getElementById('new-vm-configs');
            const section = document.getElementById('new-vm-config-section');
            container.innerHTML = '';

            if (newVMCount === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            for (let i = 1; i <= newVMCount; i++) {
                const vmIndex = existingVMCount + i;
                const vmCard = document.createElement('div');
                vmCard.className = 'vm-config-card new';
                vmCard.innerHTML = `
                    <h6>
                        <i class="fas fa-desktop me-2"></i>
                        Nueva VM ${i}
                        <span class="vm-indicator new">NUEVA</span>
                    </h6>
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Nombre</label>
                            <input type="text" class="form-control" name="new_vm_${i}_name" value="VM${vmIndex}" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">CPU</label>
                            <input type="text" class="form-control" name="new_vm_${i}_cpu" value="1" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">RAM</label>
                            <input type="text" class="form-control" name="new_vm_${i}_ram" value="1GB" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Almacenamiento</label>
                            <input type="text" class="form-control" name="new_vm_${i}_storage" value="10GB" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Imagen</label>
                            <select class="form-select" name="new_vm_${i}_image" required>
                                {% for imagen in imagenes %}
                                <option value="{{ imagen.nombre }}">{{ imagen.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">Internet</label>
                            <select class="form-select" name="new_vm_${i}_internet">
                                <option value="false">No</option>
                                <option value="true">Sí</option>
                            </select>
                        </div>
                    </div>
                `;
                container.appendChild(vmCard);
            }
        }



        function handleNewVMCountChange() {
            newVMCount = parseInt(document.getElementById('num_new_vms').value) || 0;
            generateNewVMConfig();
            updateNodeCountDisplay();
            
            if (customNodes) {
                addNewVMNodesToTopology();
            }
        }

        function selectTopology(type) {
            // Solo topología personalizada está disponible en modo edición
            document.getElementById('topology_type').value = 'custom';
            initCustomTopology();
            updateNodeCountDisplay();
        }

        function initCustomTopology() {
            const container = document.getElementById('custom-topology-container');
            
            // Initialize nodes and edges with current topology
            customNodes = new vis.DataSet(currentTopology.nodes || []);
            customEdges = new vis.DataSet(currentTopology.edges || []);
            
            // Add nodes for new VMs if any
            addNewVMNodesToTopology();
            
            const data = { nodes: customNodes, edges: customEdges };
            const options = {
                nodes: {
                    shape: 'circle',
                    size: 25,
                    font: { size: 14, color: '#333333' },
                    borderWidth: 2
                },
                edges: {
                    width: 2,
                    color: '#848484',
                    smooth: { type: 'continuous' }
                },
                physics: {
                    enabled: true,
                    stabilization: { enabled: true, iterations: 100 }
                }
            };
            
            customNetwork = new vis.Network(container, data, options);
            
            // Update topology data when network changes
            customNetwork.on('afterDrawing', updateTopologyData);
            
            updateSelectOptions();
            updateNodeCountDisplay();
        }

        function addNewVMNodesToTopology() {
            if (!customNodes) return;

            const totalExpectedNodes = existingVMCount + newVMCount;
            const currentMaxId = customNodes.length > 0 ? Math.max(...customNodes.getIds()) : 0;
            
            // Add nodes for new VMs
            for (let i = existingVMCount + 1; i <= totalExpectedNodes; i++) {
                const nodeExists = customNodes.get(i);
                if (!nodeExists) {
                    const newNode = {
                        id: i,
                        label: `VM${i}`,
                        color: { background: '#28a745', border: '#1e7e34' }
                    };
                    customNodes.add(newNode);
                }
            }
            
            updateSelectOptions();
            updateTopologyData();
        }

        function addCustomEdge() {
            const fromNode = document.getElementById('fromNode').value;
            const toNode = document.getElementById('toNode').value;
            
            if (fromNode && toNode && fromNode !== toNode) {
                const existingEdges = customEdges.get();
                const edgeExists = existingEdges.some(edge => 
                    (edge.from == fromNode && edge.to == toNode) || 
                    (edge.from == toNode && edge.to == fromNode)
                );
                
                if (edgeExists) {
                    alert('Ya existe una conexión entre estos nodos.');
                    return;
                }
                
                const newEdge = {
                    from: parseInt(fromNode),
                    to: parseInt(toNode)
                };
                customEdges.add(newEdge);
                updateTopologyData();
            } else {
                alert('Por favor selecciona dos nodos diferentes para conectar.');
            }
        }

        function updateSelectOptions() {
            const fromSelect = document.getElementById('fromNode');
            const toSelect = document.getElementById('toNode');
            
            fromSelect.innerHTML = '<option value="">Nodo origen</option>';
            toSelect.innerHTML = '<option value="">Nodo destino</option>';
            
            if (customNodes) {
                customNodes.forEach(node => {
                    const isNew = node.id > existingVMCount;
                    const indicator = isNew ? ' (Nueva)' : ' (Existente)';
                    fromSelect.innerHTML += `<option value="${node.id}">${node.label}${indicator}</option>`;
                    toSelect.innerHTML += `<option value="${node.id}">${node.label}${indicator}</option>`;
                });
            }
        }

        function updateNodeCountDisplay() {
            const totalVMs = existingVMCount + newVMCount;
            const display = document.getElementById('node-count-display');
            const info = document.getElementById('total-vm-info');
            
            if (display) {
                display.textContent = `VMs totales: ${totalVMs}`;
            }
            
            if (info) {
                info.textContent = `(${existingVMCount} existentes + ${newVMCount} nuevas)`;
            }
        }

        function updateTopologyData() {
            if (customNodes && customEdges) {
                const topologyData = {
                    nodes: customNodes.get(),
                    edges: customEdges.get()
                };
                document.getElementById('topology_data').value = JSON.stringify(topologyData);
                updateNodeCountDisplay();
            }
        }

        function showConfirmModal() {
            document.getElementById('confirmModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        function confirmSave() {
            // Capture current topology
            updateTopologyData();
            
            // Submit form
            const formData = new FormData(document.getElementById('edit-slice-form'));
            
            fetch('/update_slice/{{ slice.idslice }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.href = '/dashboard';
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error al guardar: ' + error);
            });
            
            closeModal();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            generateExistingVMConfig();
            generateNewVMConfig();
            selectTopology('custom');
        });
    </script>
</body>
</html>