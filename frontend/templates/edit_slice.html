<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleFlow - Editar Slice</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
        body { background: #f8fafc; min-height: 100vh; }
        
        .top-bar { 
            background: #ffffff; 
            border-bottom: 1px solid #e2e8f0; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); 
            padding: 1rem 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .dashboard-page {
            padding-top: 80px;
        }
        
        .logo-icon { 
            width: 40px; 
            height: 40px; 
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.25); 
        }
        
        .main-content { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 2rem 1.5rem; 
        }
        
        .page-header { 
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); 
            border-radius: 12px; 
            padding: 2rem; 
            margin-bottom: 2rem; 
            box-shadow: 0 4px 16px rgba(14, 165, 233, 0.15); 
        }
        
        .page-title { 
            font-size: 2rem; 
            font-weight: 700; 
            color: white; 
            margin-bottom: 0.5rem; 
        }
        
        .page-subtitle { 
            color: rgba(255, 255, 255, 0.9); 
            font-size: 0.95rem; 
            margin: 0; 
        }
        
        .content-card { 
            background: white; 
            border-radius: 12px; 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); 
            padding: 2rem;
            margin-bottom: 1.5rem;
        }
        
        .user-badge { 
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); 
            border: 1px solid #cbd5e1; 
            border-radius: 10px; 
            padding: 0.5rem 1rem; 
        }
        
        .user-avatar { 
            width: 32px; 
            height: 32px; 
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); 
            border-radius: 50%; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        .btn { 
            font-weight: 500; 
            border-radius: 8px; 
            padding: 0.5rem 1rem; 
            font-size: 0.875rem; 
            transition: all 0.2s ease; 
        }
        
        .btn:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
        }
        
        .btn-success { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
            border: none; 
            color: white; 
        }
        
        .btn-outline-light { 
            color: #64748b; 
            border-color: #cbd5e1; 
            background: #f8fafc; 
        }
        
        .btn-outline-light:hover { 
            background: #e2e8f0; 
            border-color: #94a3b8; 
            color: #475569; 
        }
        
        .btn-outline-secondary {
            color: #64748b;
            border-color: #cbd5e1;
            background: #f8fafc;
        }
        
        .btn-outline-secondary:hover {
            background: #e2e8f0;
            border-color: #94a3b8;
            color: #475569;
        }
        
        .vm-card.existing {
            background-color: #f8f9fa;
            border: 2px solid #6c757d;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .vm-card.new {
            background-color: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .vm-indicator {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .vm-indicator.existing {
            background-color: #6c757d;
            color: white;
        }
        
        .vm-indicator.new {
            background-color: #28a745;
            color: white;
        }
        
        .info-alert {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .topology-controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        
        #topology-container {
            height: 400px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
        }
        
        .readonly-field {
            background-color: #f8f9fa !important;
            border-color: #ced4da !important;
            color: #6c757d !important;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .step-number {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .step-title {
            color: #0f172a;
            margin: 0;
            font-weight: 600;
        }
        
        .alert {
            border-radius: 10px;
            border: 1px solid;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
        }
        
        .alert-info {
            background-color: #dbeafe;
            border-color: #93c5fd;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div class="dashboard-page">
        <!-- Barra Superior -->
        <nav class="top-bar">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-3">
                        <div class="logo-icon"><i class="fas fa-network-wired text-white"></i></div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #0f172a;">TeleFlow</div>
                            <small style="font-size: 0.7rem; color: #64748b; font-weight: 500;">Network Orchestration</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="user-badge d-flex align-items-center gap-2">
                            <div class="user-avatar"><i class="fas fa-user text-white" style="font-size: 0.75rem;"></i></div>
                            <div>
                                <div style="font-size: 0.875rem; font-weight: 600; color: #0f172a;">{{ session.username or 'Usuario' }}</div>
                                <div style="font-size: 0.7rem; color: #64748b;">Administrador</div>
                            </div>
                        </div>
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-sign-out-alt me-1"></i>Salir
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Contenido Principal -->
        <div class="main-content">
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title">Editar Slice</h1>
                        <p class="page-subtitle">Modifica tu topología de red añadiendo nuevas VMs y conexiones</p>
                    </div>
                    <div>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light">
                            <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
                        </a>
                    </div>
                </div>
            </div>

            <form method="POST" id="edit-slice-form">
                <!-- Información del Slice -->
                <div class="content-card">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <h3 class="step-title">Información del Slice</h3>
                    </div>

                    <div class="info-alert">
                        <h5><i class="fas fa-info-circle me-2"></i>Modo de Edición Seguro</h5>
                        <p class="mb-0"><strong>Solo puedes agregar nuevas VMs y modificar conexiones.</strong> Las VMs existentes se mantendrán intactas.</p>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="slice_name" name="slice_name" value="{{ slice.nombre or '' }}" required>
                                <label for="slice_name">Nombre del Slice</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="num_new_vms" name="num_new_vms" min="0" max="10" value="0" onchange="handleNewVMCountChange()">
                                <label for="num_new_vms">Nuevas VMs a agregar</label>
                            </div>
                            <small class="text-muted mt-1">Actualmente tienes {{ slice.instancias|length }} VMs existentes</small>
                        </div>
                    </div>
                </div>

                <!-- VMs Existentes -->
                <div class="content-card">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <h3 class="step-title">VMs Existentes (Solo lectura)</h3>
                    </div>

                    <div id="existing-vm-configs">
                        <!-- Se generarán automáticamente -->
                    </div>
                </div>

                <!-- Nuevas VMs -->
                <div class="content-card" id="new-vm-section" style="display: none;">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <h3 class="step-title">Configuración de Nuevas VMs</h3>
                    </div>

                    <div id="new-vm-configs">
                        <!-- Se generarán dinámicamente -->
                    </div>
                </div>

                <!-- Editor de Topología -->
                <div class="content-card">
                    <div class="step-header">
                        <div class="step-number">4</div>
                        <h3 class="step-title">Editor de Topología de Red</h3>
                    </div>

                    <div class="topology-controls">
                        <h5><i class="fas fa-tools me-2"></i>Controles de Conexión</h5>
                        <p class="text-muted">Agrega nuevas conexiones entre VMs existentes y nuevas</p>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Nodo Origen</label>
                                <select id="fromNode" class="form-select">
                                    <option value="">Seleccionar nodo origen</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Nodo Destino</label>
                                <select id="toNode" class="form-select">
                                    <option value="">Seleccionar nodo destino</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-success w-100" onclick="addCustomEdge()">
                                    <i class="fas fa-link me-1"></i>Agregar Conexión
                                </button>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="node-count-display">VMs totales: {{ slice.instancias|length }}</span>
                            <span class="text-muted ms-2" id="total-vm-info">({{ slice.instancias|length }} existentes + 0 nuevas)</span>
                        </div>
                    </div>

                    <div id="topology-container"></div>
                    <input type="hidden" id="topology_data" name="topology_data">
                </div>

                <!-- Botones de Acción -->
                <div class="content-card">
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-arrow-left me-2"></i>Cancelar
                        </a>
                        <button type="button" class="btn btn-success btn-lg" onclick="showConfirmModal()">
                            <i class="fas fa-save me-2"></i>Guardar Cambios
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmación -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-save me-2"></i>Confirmar Cambios
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-question-circle fa-3x text-warning mb-3"></i>
                    <h5>¿Confirmar los cambios?</h5>
                    <p>Se guardarán las nuevas VMs y modificaciones de topología.</p>
                    <p class="text-muted">Las VMs existentes no serán afectadas.</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-success" onclick="confirmSave()">
                        <i class="fas fa-check me-1"></i>Sí, guardar cambios
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let customNetwork = null;
        let customNodes = null;
        let customEdges = null;
        let existingVMCount = {{ slice.instancias|length }};
        let newVMCount = 0;
        
        // Convertir la topología actual de forma segura
        let currentTopology = {{ current_topology | tojson | safe }};
        if (!currentTopology || typeof currentTopology !== 'object') {
            currentTopology = { nodes: [], edges: [] };
        }

        // Datos de las instancias actuales
        let existingInstances = {{ instances_data | tojson | safe }};

        function generateExistingVMConfig() {
            const container = document.getElementById('existing-vm-configs');
            container.innerHTML = '';

            existingInstances.forEach((instance, index) => {
                const vmCard = document.createElement('div');
                vmCard.className = 'vm-card existing';
                vmCard.innerHTML = `
                    <h5>
                        <i class="fas fa-desktop me-2"></i>
                        ${instance.nombre}
                        <span class="vm-indicator existing">EXISTENTE</span>
                    </h5>
                    <div class="row">
                        <div class="col-md-2">
                            <div class="form-floating">
                                <input type="text" class="form-control readonly-field" value="${instance.cpu}" readonly>
                                <label>CPU</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-floating">
                                <input type="text" class="form-control readonly-field" value="${instance.ram}" readonly>
                                <label>RAM</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-floating">
                                <input type="text" class="form-control readonly-field" value="${instance.storage}" readonly>
                                <label>Storage</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating">
                                <input type="text" class="form-control readonly-field" value="${instance.imagen}" readonly>
                                <label>Imagen</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating">
                                <input type="text" class="form-control readonly-field" value="${instance.salidainternet ? 'Sí' : 'No'}" readonly>
                                <label>Internet</label>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(vmCard);
            });
        }

        function generateNewVMConfig() {
            const container = document.getElementById('new-vm-configs');
            const section = document.getElementById('new-vm-section');
            container.innerHTML = '';

            if (newVMCount === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            for (let i = 1; i <= newVMCount; i++) {
                const vmIndex = existingVMCount + i;
                const vmCard = document.createElement('div');
                vmCard.className = 'vm-card new';
                vmCard.innerHTML = `
                    <h5>
                        <i class="fas fa-desktop me-2"></i>
                        Nueva VM ${i}
                        <span class="vm-indicator new">NUEVA</span>
                    </h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" name="new_vm_${i}_name" value="VM${vmIndex}" required>
                                <label>Nombre</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">CPU</label>
                            <select class="form-select" name="new_vm_${i}_cpu" required>
                                <option value="1">1 Core</option>
                                <option value="2">2 Cores</option>
                                <option value="4">4 Cores</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">RAM</label>
                            <select class="form-select" name="new_vm_${i}_ram" required>
                                <option value="1GB">1GB</option>
                                <option value="2GB">2GB</option>
                                <option value="4GB">4GB</option>
                                <option value="8GB">8GB</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Storage</label>
                            <select class="form-select" name="new_vm_${i}_storage" required>
                                <option value="10GB">10GB</option>
                                <option value="20GB">20GB</option>
                                <option value="50GB">50GB</option>
                                <option value="100GB">100GB</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Imagen</label>
                            <select class="form-select" name="new_vm_${i}_image" required>
                                {% for imagen in imagenes %}
                                <option value="{{ imagen.nombre }}">{{ imagen.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">Internet</label>
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" name="new_vm_${i}_internet">
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(vmCard);
            }
        }

        function handleNewVMCountChange() {
            newVMCount = parseInt(document.getElementById('num_new_vms').value) || 0;
            generateNewVMConfig();
            updateNodeCountDisplay();
            
            if (customNodes) {
                addNewVMNodesToTopology();
            }
        }

        function initCustomTopology() {
            const container = document.getElementById('topology-container');
            
            // Initialize nodes and edges with current topology
            customNodes = new vis.DataSet(currentTopology.nodes || []);
            customEdges = new vis.DataSet(currentTopology.edges || []);
            
            // Add nodes for new VMs if any
            addNewVMNodesToTopology();
            
            const data = { nodes: customNodes, edges: customEdges };
            const options = {
                nodes: {
                    shape: 'circle',
                    size: 30,
                    font: { size: 14, color: '#333' },
                    borderWidth: 3,
                    color: {
                        background: '#28a745',
                        border: '#1e7e34',
                        highlight: { background: '#20c997', border: '#17a2b8' }
                    }
                },
                edges: {
                    width: 3,
                    color: '#6c757d',
                    smooth: { type: 'continuous' }
                },
                physics: {
                    enabled: true,
                    stabilization: { iterations: 100 }
                },
                interaction: {
                    dragNodes: true,
                    dragView: true,
                    zoomView: true
                }
            };
            
            customNetwork = new vis.Network(container, data, options);
            
            // Update topology data when network changes
            customNetwork.on('afterDrawing', updateTopologyData);
            
            updateSelectOptions();
            updateNodeCountDisplay();
        }

        function addNewVMNodesToTopology() {
            if (!customNodes) return;

            const totalExpectedNodes = existingVMCount + newVMCount;
            
            // Add nodes for new VMs
            for (let i = existingVMCount + 1; i <= totalExpectedNodes; i++) {
                const nodeExists = customNodes.get(i);
                if (!nodeExists) {
                    const newNode = {
                        id: i,
                        label: `VM${i}`,
                        color: { background: '#17a2b8', border: '#138496' }
                    };
                    customNodes.add(newNode);
                }
            }
            
            updateSelectOptions();
            updateTopologyData();
        }

        function addCustomEdge() {
            const fromNode = document.getElementById('fromNode').value;
            const toNode = document.getElementById('toNode').value;
            
            if (fromNode && toNode && fromNode !== toNode) {
                const existingEdges = customEdges.get();
                const edgeExists = existingEdges.some(edge => 
                    (edge.from == fromNode && edge.to == toNode) || 
                    (edge.from == toNode && edge.to == fromNode)
                );
                
                if (edgeExists) {
                    alert('Ya existe una conexión entre estos nodos.');
                    return;
                }
                
                const newEdge = {
                    from: parseInt(fromNode),
                    to: parseInt(toNode)
                };
                customEdges.add(newEdge);
                updateTopologyData();
                
                // Reset selections
                document.getElementById('fromNode').value = '';
                document.getElementById('toNode').value = '';
            } else {
                alert('Por favor selecciona dos nodos diferentes para conectar.');
            }
        }

        function updateSelectOptions() {
            const fromSelect = document.getElementById('fromNode');
            const toSelect = document.getElementById('toNode');
            
            fromSelect.innerHTML = '<option value="">Seleccionar nodo origen</option>';
            toSelect.innerHTML = '<option value="">Seleccionar nodo destino</option>';
            
            if (customNodes) {
                customNodes.forEach(node => {
                    const isNew = node.id > existingVMCount;
                    const indicator = isNew ? ' (Nueva)' : ' (Existente)';
                    fromSelect.innerHTML += `<option value="${node.id}">${node.label}${indicator}</option>`;
                    toSelect.innerHTML += `<option value="${node.id}">${node.label}${indicator}</option>`;
                });
            }
        }

        function updateNodeCountDisplay() {
            const totalVMs = existingVMCount + newVMCount;
            const display = document.getElementById('node-count-display');
            const info = document.getElementById('total-vm-info');
            
            if (display) {
                display.textContent = `VMs totales: ${totalVMs}`;
            }
            
            if (info) {
                info.textContent = `(${existingVMCount} existentes + ${newVMCount} nuevas)`;
            }
        }

        function updateTopologyData() {
            if (customNodes && customEdges) {
                const topologyData = {
                    nodes: customNodes.get(),
                    edges: customEdges.get()
                };
                document.getElementById('topology_data').value = JSON.stringify(topologyData);
            }
        }

        function showConfirmModal() {
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
        }

        function confirmSave() {
            // Capture current topology
            updateTopologyData();
            
            // Submit form
            const formData = new FormData(document.getElementById('edit-slice-form'));
            
            fetch('/update_slice/{{ slice.idslice }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.href = '/dashboard';
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error al guardar: ' + error);
            });
            
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
            modal.hide();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            generateExistingVMConfig();
            generateNewVMConfig();
            initCustomTopology();
        });
    </script>
</body>
</html>